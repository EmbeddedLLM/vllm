name: Build ROCm Wheel Matrix

on:
  workflow_dispatch:  # Manual trigger only
    inputs:
      upload_to_s3:
        description: 'Upload wheels to S3 (requires AWS credentials)'
        required: false
        default: 'false'
        type: boolean

jobs:
  build-rocm-wheels:
    runs-on: ubuntu-latest

    strategy:
      fail-fast: false
      matrix:
        python-version: ['3.10', '3.11', '3.12', '3.13']
        # Currently using nightly - stable releases will be available later
        # When stable is available, change to: pytorch-version: ['2.9.0', '2.10.0']
        pytorch-index: ['nightly']

    name: Build (Python ${{ matrix.python-version }}, PyTorch nightly)

    steps:
      - name: Free Disk Space (Ubuntu)
        uses: jlumbroso/free-disk-space@main
        with:
          # Keep tool-cache since we might need it
          tool-cache: false
          android: true
          dotnet: true
          haskell: true
          large-packages: true
          docker-images: false  # Keep Docker since we need it
          swap-storage: false

      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run build in ROCm container
        run: |
          docker run --rm \
            -v ${{ github.workspace }}:/workspace \
            -w /workspace \
            rocm/dev-ubuntu-22.04:7.0-complete \
            bash -c '
              set -e
              export DEBIAN_FRONTEND=noninteractive
              export TZ=Etc/UTC

              # Install system dependencies
              apt-get update
              apt-get install -y software-properties-common curl git ninja-build

              # Install Python
              PY_VER="${{ matrix.python-version }}"
              add-apt-repository -y ppa:deadsnakes/ppa
              apt-get update
              apt-get install -y python${PY_VER} python${PY_VER}-dev python${PY_VER}-venv

              # Create virtual environment
              python${PY_VER} -m venv /opt/venv
              . /opt/venv/bin/activate

              # Install build dependencies
              python -m pip install --upgrade pip setuptools wheel
              python -m pip install cmake ninja packaging pybind11

              # Install PyTorch nightly
              # Currently using nightly builds - stable releases will be available later
              # Once stable releases are available, switch matrix to pytorch-version and update to:
              # python -m pip install torch==VERSION+rocm7.0 -f https://download.pytorch.org/whl/torch_stable.html
              python -m pip install --pre torch --index-url https://download.pytorch.org/whl/nightly/rocm7.0

              # Verify PyTorch
              python -c "import torch; print(f\"PyTorch: {torch.__version__}\")"
              python -c "import torch; print(f\"ROCm: {torch.version.hip}\")"
              python -c "import sys; print(f\"Python: {sys.version}\")"

              # Build vLLM wheel
              export VLLM_TARGET_DEVICE=rocm
              export ROCM_PATH=/opt/rocm
              export PATH=/opt/rocm/bin:$PATH
              export LD_LIBRARY_PATH=/opt/rocm/lib:$LD_LIBRARY_PATH
              export MAX_JOBS=4

              python setup.py bdist_wheel --dist-dir=dist

              # List built wheel
              ls -lh dist/
            '

      - name: List built wheel
        run: |
          ls -lh dist/
          echo "Built wheel:"
          ls dist/*.whl
          # Wheel name is automatically generated by setup.py with correct version tags

      - name: Upload wheel as artifact
        uses: actions/upload-artifact@v4
        with:
          name: vllm-rocm70-torch-nightly-py${{ matrix.python-version }}-wheel
          path: dist/*.whl
          retention-days: 30

      - name: Upload to S3 (Optional)
        if: ${{ github.event.inputs.upload_to_s3 == 'true' }}
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          AWS_DEFAULT_REGION: us-west-2
        run: |
          # Install AWS CLI
          pip install awscli

          # Get commit hash
          COMMIT=$(git rev-parse HEAD)

          # Upload to S3
          aws s3 cp dist/*.whl s3://vllm-wheels/rocm/${COMMIT}/

          echo "Uploaded wheel to s3://vllm-wheels/rocm/${COMMIT}/"

      - name: Display wheel info
        run: |
          pip install pkginfo
          python -m pkginfo dist/*.whl

  summary:
    needs: build-rocm-wheels
    runs-on: ubuntu-latest
    if: always()

    steps:
      - name: Build Summary
        run: |
          echo "## ROCm Wheel Build Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Built wheels for:" >> $GITHUB_STEP_SUMMARY
          echo "- Python versions: 3.10, 3.11, 3.12, 3.13" >> $GITHUB_STEP_SUMMARY
          echo "- PyTorch version: nightly (latest dev)" >> $GITHUB_STEP_SUMMARY
          echo "- ROCm version: 7.0" >> $GITHUB_STEP_SUMMARY
          echo "- Platform: manylinux_2_17_x86_64" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Total wheels: 4 (one per Python version)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ "${{ github.event.inputs.upload_to_s3 }}" == "true" ]; then
            echo "âœ… Wheels uploaded to S3" >> $GITHUB_STEP_SUMMARY
          else
            echo "ðŸ“¦ Wheels available as GitHub Actions artifacts" >> $GITHUB_STEP_SUMMARY
          fi
