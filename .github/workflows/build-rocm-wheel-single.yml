name: Build ROCm Wheel (Single Variant - Testing)

on:
  workflow_dispatch:  # Manual trigger only

jobs:
  build-rocm-wheel:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        python-version: ["3.12"]

    steps:
      - name: Free Disk Space (Ubuntu)
        uses: jlumbroso/free-disk-space@main
        with:
          # Keep tool-cache since we might need it
          tool-cache: false
          android: true
          dotnet: true
          haskell: true
          large-packages: true
          docker-images: false  # Keep Docker since we need it
          swap-storage: false

      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run build in ROCm container
        run: |
          docker run --rm \
            -v ${{ github.workspace }}:/workspace \
            -w /workspace \
            rocm/dev-ubuntu-22.04:7.0-complete \
            bash -c '
              set -e
              # Install system dependencies
              export DEBIAN_FRONTEND=noninteractive
              export TZ=Etc/UTC

              apt-get update
              apt-get install -y \
                software-properties-common \
                wget \
                build-essential \
                libnuma-dev \
                gcc \
                g++ \
                make \
                git \
                curl \
                ca-certificates \
                patchelf \ 
                sqlite3 libsqlite3-dev libfmt-dev libmsgpack-dev libsuitesparse-dev \
                apt-transport-https ca-certificates wget curl

              # Install Python
              PY_VER="${{ matrix.python-version }}"
              add-apt-repository -y ppa:deadsnakes/ppa
              apt-get update
              apt-get install -y \
                python${PY_VER} \
                python${PY_VER}-dev \
                python${PY_VER}-venv

              # Create virtual environment
              python${PY_VER} -m venv /opt/venv
              . /opt/venv/bin/activate

              # Install build dependencies
              python -m pip install --upgrade pip setuptools wheel
              python -m pip install cmake ninja packaging build setuptools_scm pybind11 numpy auditwheel

              # Remove sccache as done in Dockerfile.rocm
              apt-get purge -y sccache || true
              python -m pip uninstall -y sccache || true
              rm -f "$(which sccache)" || true

              # Install ROCm requirements
              python -m pip install -r requirements/rocm.txt 

              # Install PyTorch
              # Currently using nightly builds - stable releases will be available later
              # Once stable releases are available, update to: torch==2.X.0+rocm7.0
              python -m pip install --pre torch --index-url https://download.pytorch.org/whl/nightly/rocm7.0

              # Verify PyTorch
              python -c "import torch; print(f\"PyTorch: {torch.__version__}, ROCm: {torch.version.hip}\")"

              # Build wheel
              export VLLM_TARGET_DEVICE=rocm
              export ROCM_PATH=/opt/rocm
              export PATH=/opt/rocm/bin:$PATH
              export LD_LIBRARY_PATH=/opt/rocm/lib:$LD_LIBRARY_PATH
              export MAX_JOBS=4
              export PYTORCH_ROCM_ARCH=gfx942

              python setup.py bdist_wheel --dist-dir=dist

              # List wheel
              ls -lh dist/
            '

      - name: List built wheels
        run: |
          ls -lh dist/
          echo "Built wheel:"
          ls dist/*.whl

      - name: Upload wheel as artifact
        uses: actions/upload-artifact@v4
        with:
          name: vllm-rocm70-torch-nightly-py${{ matrix.python-version }}-wheel
          path: dist/*.whl
          retention-days: 30

      - name: Display wheel info
        run: |
          pip install pkginfo
          python -m pkginfo dist/*.whl
