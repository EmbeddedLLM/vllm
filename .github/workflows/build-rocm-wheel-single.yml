name: Build ROCm Wheel (Single Variant - Testing)

on:
  workflow_dispatch:  # Manual trigger only

jobs:
  build-rocm-wheel:
    runs-on: ubuntu-latest
    container:
      image: rocm/dev-ubuntu-22.04:7.0-complete
      options: --user root

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python 3.12 and create virtual environment
        run: |
          # Prevent interactive prompts during package installation
          export DEBIAN_FRONTEND=noninteractive
          export TZ=Etc/UTC

          apt-get update
          apt-get install -y software-properties-common curl git ninja-build

          # Try to install Python from deadsnakes PPA
          add-apt-repository -y ppa:deadsnakes/ppa
          apt-get update

          # Install Python and venv
          apt-get install -y python3.12 python3.12-dev python3.12-venv
          python3.12 --version

          # Create virtual environment
          python3.12 -m venv /opt/venv

          # Activate venv and verify
          . /opt/venv/bin/activate
          python --version
          python -m pip --version

      - name: Install PyTorch 2.10.0 with ROCm 7.0
        run: |
          . /opt/venv/bin/activate
          python -m pip install --upgrade pip setuptools wheel
          python -m pip install torch==2.10.0+rocm7.0 -f https://download.pytorch.org/whl/torch_stable.html

      - name: Verify PyTorch installation
        run: |
          . /opt/venv/bin/activate
          python -c "import torch; print(f'PyTorch version: {torch.__version__}')"
          python -c "import torch; print(f'ROCm version: {torch.version.hip}')"

      - name: Install build dependencies
        run: |
          . /opt/venv/bin/activate
          python -m pip install cmake ninja packaging pybind11

      - name: Build vLLM wheel
        run: |
          . /opt/venv/bin/activate
          export VLLM_TARGET_DEVICE=rocm
          export ROCM_PATH=/opt/rocm
          export PATH=/opt/rocm/bin:$PATH
          export LD_LIBRARY_PATH=/opt/rocm/lib:$LD_LIBRARY_PATH
          python setup.py bdist_wheel --dist-dir=dist
        env:
          MAX_JOBS: 4

      - name: List built wheels
        run: |
          ls -lh dist/
          echo "Wheel name:"
          ls dist/*.whl

      - name: Upload wheel as artifact
        uses: actions/upload-artifact@v4
        with:
          name: vllm-rocm70-torch210-cp312-wheel
          path: dist/*.whl
          retention-days: 30

      - name: Display wheel info
        run: |
          . /opt/venv/bin/activate
          python -m pip install pkginfo
          python -m pkginfo dist/*.whl
